# docker-compose -f mqtt-explorer.yml -p mqtt-explorer up -d
version: '2.4'
services:

  # MQTT-Explorer - MQTT Web Client Tool (wss:// and mqtt:// connections)
  # https://mqtt-explorer.com/
  # https://github.com/thomasnordquist/MQTT-Explorer
  # https://github.com/thomasnordquist/MQTT-Explorer/blob/master/Dockerfile.browser
  # https://github.com/thomasnordquist/MQTT-Explorer/blob/master/docker-compose.yml
  # Supported architectures: arm32v7, arm64v8, amd64
  # fix permission problem before startup: "mkdir ./data_mqtt-explorer/ && chmod 777 ./data_mqtt-explorer/"
  mqtt-explorer:
    image: ghcr.io/thomasnordquist/mqtt-explorer:latest
    container_name: mqtt-explorer
    restart: unless-stopped
    environment:
      - MQTT_EXPLORER_USERNAME=admin
      - MQTT_EXPLORER_PASSWORD=changeme
      # Uncomment to disable authentication (use only behind a secure proxy!)
      #- MQTT_EXPLORER_SKIP_AUTH=true
      # SSL (example: own CA certificate)
      #- NODE_EXTRA_CA_CERTS=/ssl/ca.crt
    volumes:
      - ./data_mqtt-explorer:/app/data:rw
    #  - ./ssl:/ssl:ro
    #ports:
    #  - 3000:3000/tcp
    #healthcheck:
    #  test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
    #  interval: 30s
    #  timeout: 10s
    #  retries: 3
    #  start_period: 40s
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=mynetwork"
      - "traefik.http.services.mqtt-explorer.loadbalancer.server.port=3000"
      - "traefik.http.services.mqtt-explorer.loadbalancer.server.scheme=http"  # when "https" then set "--serversTransport.insecureSkipVerify=true" for traefik
      # http
      - "traefik.http.routers.mqtt-explorer-http.rule=Host(`mqtt-explorer.example.com`)"
      - "traefik.http.routers.mqtt-explorer-http.entrypoints=web"
      - "traefik.http.routers.mqtt-explorer-http.service=mqtt-explorer"
      # https
      - "traefik.http.routers.mqtt-explorer-https.tls=true"
      - "traefik.http.routers.mqtt-explorer-https.rule=Host(`mqtt-explorer.example.com`)"
      - "traefik.http.routers.mqtt-explorer-https.entrypoints=websecure"
      - "traefik.http.routers.mqtt-explorer-https.service=mqtt-explorer"
      # load middlewares for routes
      - "traefik.http.routers.mqtt-explorer-http.middlewares=mqtt-explorer-https"
      # http to https redirect      
      - "traefik.http.middlewares.mqtt-explorer-https.redirectscheme.scheme=https"
      #- "traefik.http.middlewares.mqtt-explorer-https.redirectscheme.permanent=true"
      #- "traefik.http.middlewares.mqtt-explorer-https.redirectscheme.port=443"

networks:
  default:
    external: true
    name: mynetwork
